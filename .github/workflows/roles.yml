name: Cyber Roles Testing

on:
  workflow_dispatch:
  schedule:
    - cron: '0 16 */1 * *'

jobs:
  arch-role-testing:
    runs-on: ubuntu-latest
    container:
      image: athenaos/base-devel:latest
      options: --privileged

    strategy:
      fail-fast: false  # Ensure all matrix jobs continue even if one fails
      matrix:
        role_installer:
          - { role: "blue", job_name: "ğŸ’™ Blue Teamer ğŸ’™ Arch" }
          - { role: "bugbounty", job_name: "ğŸ Bug Bounty Hunter ğŸ Arch" }
          - { role: "cracker", job_name: "ğŸ˜ Cracker Specialist ğŸ˜ Arch" }
          - { role: "dos", job_name: "ğŸ’€ DoS Tester ğŸ’€ Arch" }
          - { role: "student", job_name: "ğŸ“ Enthusiast Student ğŸ“ Arch" }
          - { role: "forensic", job_name: "ğŸ” Forensic Analyst ğŸ” Arch" }
          - { role: "malware", job_name: "ğŸ¦  Malware Analyst ğŸ¦  Arch" }
          - { role: "mobile", job_name: "ğŸ“± Mobile Analyst ğŸ“± Arch" }
          - { role: "network", job_name: "ğŸŒ Network Analyst ğŸŒ Arch" }
          - { role: "osint", job_name: "ğŸ•µï¸ OSINT Specialist ğŸ•µï¸ Arch" }
          - { role: "red", job_name: "â¤ï¸ Red Teamer â¤ï¸ Arch" }
          - { role: "web", job_name: "ğŸ•¸ï¸ Web Pentester ğŸ•¸ï¸ Arch" }


    name: ${{ matrix.role_installer.job_name }} Install # Dynamically assign the job name based on the matrix

    steps:
      - name: Install dependencies
        run: pacman -Syyu --noconfirm cyber-toolkit
      - name: Install role
        run: cyber-toolkit ${{ matrix.role_installer.role }}

  nix-role-testing:
    runs-on: ubuntu-latest
    container:
      image: nixos/nix:latest
      options: --privileged
    strategy:
      fail-fast: false  # Ensure all matrix jobs continue even if one fails
      matrix:
        role_installer:
          - { role: "blue", job_name: "ğŸ’™ Blue Teamer ğŸ’™ Nix" }
          - { role: "bugbounty", job_name: "ğŸ Bug Bounty Hunter ğŸ Nix" }
          - { role: "cracker", job_name: "ğŸ˜ Cracker Specialist ğŸ˜ Nix" }
          - { role: "dos", job_name: "ğŸ’€ DoS Tester ğŸ’€ Nix" }
          - { role: "student", job_name: "ğŸ“ Enthusiast Student ğŸ“ Nix" }
          - { role: "forensic", job_name: "ğŸ” Forensic Analyst ğŸ” Nix" }
          - { role: "malware", job_name: "ğŸ¦  Malware Analyst ğŸ¦  Nix" }
          - { role: "mobile", job_name: "ğŸ“± Mobile Analyst ğŸ“± Nix" }
          - { role: "network", job_name: "ğŸŒ Network Analyst ğŸŒ Nix" }
          - { role: "osint", job_name: "ğŸ•µï¸ OSINT Specialist ğŸ•µï¸ Nix" }
          - { role: "red", job_name: "â¤ï¸ Red Teamer â¤ï¸ Nix" }
          - { role: "web", job_name: "ğŸ•¸ï¸ Web Pentester ğŸ•¸ï¸ Nix" }
          
    name: ${{ matrix.role_installer.job_name }} Install # Dynamically assign the job name based on the matrix
    steps:
      - name: Install role
        run: |
          git clone https://github.com/Athena-OS/athena-nix
          nix-shell --expr '{ pkgs ? import <nixpkgs> { config.allowUnfree = true; } }: pkgs.mkShell { buildInputs = (import ./athena-nix/nixos/modules/cyber/roles/${{ matrix.role_installer.role }}.nix { inherit pkgs; }); }'

  # Final job to send summary to webhook
  notify-result:
    runs-on: ubuntu-latest
    needs: [arch-role-testing, nix-role-testing]  # Wait until all matrix jobs complete
    if: always()  # Ensures this job runs even if any job fails or is canceled
    steps:
      - name: Generate Job Results Summary
        id: generate_summary
        run: |
          summary="Job Results:"
          # Convert the entire 'needs' context to JSON
          job_data=$(echo '${{ toJSON(needs) }}' | jq .)
          # Loop over each job and collect the results
          for job_name in $(echo "$job_data" | jq -r 'keys[]'); do
            job_result=$(echo "$job_data" | jq -r --arg job "$job_name" '.[$job].result')
            summary="$summary\n$job_name: $job_result"
          done
          # Output the summary to be used in later steps
          echo "$summary"
          echo "::set-output name=job-summary::$summary"
      - name: Send a request to webhook
        run: |
          curl -H "Content-Type: application/json" -d '{
            "embeds": [{
              "type": "rich",
              "title": "Workflow Actions",
              "thumbnail": {
                "url": "https://athenaos.org/_astro/athena-chibi.C4AxdAFD_Z1ifHWb.webp"
              },
              "author": {
                "name": "${{ github.actor }}",
                "url": "https://github.com/${{ github.actor }}",
                "icon_url": "https://avatars.githubusercontent.com/u/${{ github.actor_id }}?v=4"
              }
            }],
            "username": "Athena Git Ninja",
            "content": "Athena Cyber Roles Test\nBranch: ${{ github.ref }} \nCommit Hash: ${{ github.sha }}\n\n${{ steps.generate_summary.outputs.job-summary }}"
          }' ${{ secrets.WEBHOOK_URL }}
