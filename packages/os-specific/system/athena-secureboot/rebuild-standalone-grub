#!/usr/bin/env bash
set -euo pipefail

EFI_OUT=/tmp/GRUB.EFI
EFI_GRUB_DIR=/boot/efi/EFI/GRUB
EFI_BOOT_DIR=/boot/efi/EFI/BOOT
CERT=/etc/.secureboot/keys/MOK.crt
KEY=/etc/.secureboot/keys/MOK.key

# Modules you actually need; keep lean but sufficient
EXTRA_GRUB_MODULES="bli boot cat efifwsetup efinet gcry_arcfour gcry_blowfish gcry_camellia gcry_cast5 gcry_crc gcry_des gcry_dsa gcry_idea gcry_md4 gcry_md5 gcry_rfc2268 gcry_rijndael gcry_rmd160 gcry_rsa gcry_seed gcry_serpent gcry_sha1 gcry_sha256 gcry_sha512 gcry_tiger gcry_twofish gcry_whirlpool gfxterm_background halt help hfsplus iso9660 jpeg keystatus loopback ls lsefi lsefimmap lsefisystab lssal memdisk minicmd part_apple password_pbkdf2 png raid5rec raid6rec reboot serial sleep smbios squash4 true video zfs zfscrypt zfsinfo"

MINIMUM_GRUB_MODULES="all_video btrfs chain configfile cryptodisk echo efi_gop efi_uga ext2 exfat fat font gettext gfxmenu gfxterm gzio linux loadenv luks lvm mdraid09 mdraid1x normal ntfs ntfscomp part_gpt part_msdos probe regexp search search_fs_file search_fs_uuid search_label test tpm udf"

GRUB_MODULES=$(echo "$MINIMUM_GRUB_MODULES $EXTRA_GRUB_MODULES" | xargs)

# (Optional) regenerate grub.cfg first if we rely on mkconfig
# grub-mkconfig -o /boot/grub/grub.cfg

grub-mkstandalone -O x86_64-efi \
  -o "$EFI_OUT" \
  --modules="$GRUB_MODULES" \
  --sbat /usr/share/grub/sbat.csv \
  "boot/grub/grub.cfg=/boot/grub/grub.cfg" \
  "boot/grub/fonts/unicode.pf2=/usr/share/grub/unicode.pf2"
  # add more "boot/grub/themes/..." lines if we embed a theme

# Sign and install next to shim, mirror into EFI/GRUB
sbsign --key "$KEY" --cert "$CERT" --output "$EFI_BOOT_DIR/grubx64.efi" "$EFI_OUT"
install -Dm 0644 "$EFI_BOOT_DIR/grubx64.efi" "$EFI_GRUB_DIR/grubx64.efi"
