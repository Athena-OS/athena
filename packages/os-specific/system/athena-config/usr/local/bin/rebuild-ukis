#!/bin/bash
set -euo pipefail

# --- Config ---------------------------------------------------------------

# Where to put the finished UKIs on the ESP:
ESP_DIR="/efi/EFI/Athena"

# Secure Boot signing material:
SB_KEY="/etc/secureboot/keys/MOK.key"
SB_CRT="/etc/secureboot/keys/MOK.crt"

# Kernel cmdline file:
CMDLINE_FILE="/etc/kernel/cmdline"

# PCR key locations generated by the installer via `ukify genkey`
SYS_PRIV="/etc/systemd/tpm2-pcr-private-key-system.pem"
SYS_PUB="/etc/systemd/tpm2-pcr-public-key-system.pem"
INIT_PRIV="/etc/systemd/tpm2-pcr-initrd-private-key.pem"
INIT_PUB="/etc/systemd/tpm2-pcr-initrd-public-key.pem"

# Phases
PHASES_SYSTEM="enter-initrd"
PHASES_INITRD="enter-initrd"

# --- Prep ----------------------------------------------------------------

install -dm 755 "${ESP_DIR}"

DO_SIGN=false
if [[ -f "$SB_KEY" && -f "$SB_CRT" ]]; then
  DO_SIGN=true
fi

# TPM present?
TPM_PRESENT=false
if [[ -e /dev/tpmrm0 || -e /dev/tpm0 ]]; then
  TPM_PRESENT=true
fi

# Decide if we can do --measure and collect the key/phase pairs
MEASURE_ARGS=()
if $TPM_PRESENT; then
  # helper to append one keypair+phases (keeping ukify's required pairing)
  add_pair() {
    local priv="$1" pub="$2" phases="$3"
    MEASURE_ARGS+=( --pcr-private-key "$priv" --pcr-public-key "$pub" --phases "$phases" )
  }
  # System (full-boot) policy
  if [[ -f "$SYS_PRIV" && -f "$SYS_PUB" ]]; then
    add_pair "$SYS_PRIV" "$SYS_PUB" "$PHASES_SYSTEM"
  fi
  # Initrd-only policy
  if [[ -f "$INIT_PRIV" && -f "$INIT_PUB" ]]; then
    add_pair "$INIT_PRIV" "$INIT_PUB" "$PHASES_INITRD"
  fi
fi

DO_MEASURE=false
if [[ ${#MEASURE_ARGS[@]} -gt 0 ]]; then
  DO_MEASURE=true
fi

# --- Build all UKIs ------------------------------------------------------

for vmlinuz in /boot/vmlinuz-*; do
  [[ -e "$vmlinuz" ]] || continue

  kbase="$(basename "$vmlinuz")"          # e.g. vmlinuz-linux
  kname="${kbase#vmlinuz-}"               # e.g. linux or linux-lts
  initrd="/boot/initramfs-${kname}.img"
  out="${ESP_DIR}/${kname}.efi"

  MICROCODE=()
  if [[ -f /boot/intel-ucode.img ]]; then
    MICROCODE+=( --initrd /boot/intel-ucode.img )
  elif [[ -f /boot/amd-ucode.img ]]; then
    MICROCODE+=( --initrd /boot/amd-ucode.img )
  fi

  echo ">> Building UKI for kernel '${kname}' â†’ ${out}"

  # common args
  UKIFY=( /usr/bin/ukify build
          --linux "$vmlinuz"
          "${MICROCODE[@]}"
          --initrd "$initrd"
          --cmdline @"${CMDLINE_FILE}"
          --os-release /usr/lib/os-release
          --uname "${kname}"
  )

  # PCR measurement (only when TPM present AND we have at least one keypair)
  if $DO_MEASURE; then
    UKIFY+=( --measure "${MEASURE_ARGS[@]}" )
  fi

  # Secure Boot signing (optional)
  if $DO_SIGN; then
    UKIFY+=( --signtool=sbsign
             --secureboot-private-key "${SB_KEY}"
             --secureboot-certificate "${SB_CRT}" )
  fi

  UKIFY+=( --output "${out}" )

  # run
  "${UKIFY[@]}"
done
