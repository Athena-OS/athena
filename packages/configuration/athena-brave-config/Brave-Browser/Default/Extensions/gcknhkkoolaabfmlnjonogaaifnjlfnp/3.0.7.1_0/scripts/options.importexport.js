var checkBoolean=function(a,b){return"true"==a?!0:b},checkNumeric=function(a){return $.isNumeric(a)?a:0},checkValidType=function(a){return"direct"===a||"manual"===a||"auto"===a?a:"direct"},importPatterns=function(a,b){try{console.log("trying import patterns for",b.data.name);for(var c,d=a.getElementsByTagName("matches")[0].getElementsByTagName("match"),e=0,f=d.length,g=[];f>e;e++)c=new ProxyPattern,c.data.enabled=checkBoolean(d[e].getAttribute("enabled"),!1),c.data.temp=!1,c.data.name=d[e].getAttribute("name"),c.data.url=d[e].getAttribute("pattern"),console.log("isRegexp for ",c.data.name,"is",d[e].getAttribute("isRegEx")),c.data.type="true"==d[e].getAttribute("isRegEx")?"regexp":"wildcard",c.data.whitelist="true"==d[e].getAttribute("isBlackList")?"Exclusive":"Inclusive",g.push(c);b.data.patterns=g}catch(h){return}},importProxies=function(a){for(var b,c,d=0,e=a.getElementsByTagName("proxies")[0].getElementsByTagName("proxy");d<e.length;d++)b=new Proxy,b.data.type=checkValidType(e[d].getAttribute("mode")),b.data.name=e[d].getAttribute("name"),b.data.notes=e[d].getAttribute("notes"),b.data.enabled=checkBoolean(e[d].getAttribute("enabled")),b.data.cycle=checkBoolean(e[d].getAttribute("includeInCycle")),b.data.useDns=checkBoolean(e[d].getAttribute("proxyDNS")),b.data.color=e[d].getAttribute("color"),void 0!=e[d].getElementsByTagName("manualconf")[0]?(c=e[d].getElementsByTagName("manualconf")[0],b.data.isSocks=checkBoolean(c.getAttribute("isSocks")),b.data.socks=checkNumeric(c.getAttribute("socksversion"),5),b.data.host=c.getAttribute("host"),b.data.port=checkNumeric(c.getAttribute("port"),0)):(b.data.isSocks=!1,b.data.socks=5),b.data.notifOnLoad=!0,b.data.notifOnError=!0,void 0!=e[d].getElementsByTagName("autoconf")[0]?(c=e[d].getElementsByTagName("autoconf")[0],b.data.reloadPAC=checkBoolean(c.getAttribute("autoReload")),b.data.configUrl=c.getAttribute("url")):b.data.reloadPAC=!1,importPatterns(e[d],b,a),"Default"==b.data.name?(deleteDefaultProxy(),b.data.id="default",b.data.readonly=!0,list.push(b)):list.splice(0,0,b);placeDefaultToBottom()};window.onload=function(){window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;var a,b=document.querySelector("#settings-import");b.onchange=function(b){a=b.target.files[0];var c=new FileReader;c.onload=function(a){try{var b=$.parseXML(a.target.result),c=function(){try{importProxies(b),updateProxyTable(),saveProxies(list)}catch(a){console.log("error importing",a)}},d=function(){var a;if(list&&list.length)for(a=list.length-1;a>=0;a--)"Default"!=list[a].data.name&&deleteProxy(a);updateProxyTable(),saveProxies(list),c()};$("#import-dialog").dialog({resizable:!1,height:200,modal:!0,buttons:{Replace:function(){d(),$(this).dialog("close")},Add:function(){c(),$(this).dialog("close")},Nevermind:function(){$(this).dialog("close")}}}),$("#import-result").text(chrome.i18n.getMessage("import_success"))}catch(e){$("#import-result").text(chrome.i18n.getMessage("import_error"))}},c.readAsText(a)}};var setDefaultFoxyProxySettings=function(a,b){var c,d,e={mode:"disabled",selectedTabIndex:"0",toolbaricon:"true",toolsMenu:"true",contextMenu:"true",advancedMenus:"false",previousMode:"disabled",resetIconColors:"true",useStatusBarPrefix:"true",excludePatternsFromCycling:"false",excludeDisabledFromCycling:"false",ignoreProxyScheme:"false",apiDisabled:"false",proxyForVersionCheck:""};for(c in e)a.setAttribute(c,e[c]);var f=b.createElement("random");f.setAttribute("includeDirect",!1),f.setAttribute("includeDisabled",!1);var g={icon:!0,text:!1,left:"options",middle:"cycle",right:"contextmenu",width:0},h=b.createElement("statusbar");for(c in g)h.setAttribute(c,g[c]);var i={left:"options",middle:"cycle",right:"contextmenu"},j=b.createElement("toolbar");for(c in i)j.setAttribute(c,i[c]);var k=b.createElement("logg");k.setAttribute("enabled",!1),k.setAttribute("maxSize","500"),k.setAttribute("noURLs",!1),k.setAttribute("header","&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd&quot;&gt;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;&lt;head&gt;&lt;title&gt;&lt;/title&gt;&lt;link rel=&quot;icon&quot; href=&quot;http://getfoxyproxy.org/favicon.ico&quot;/&gt;&lt;link rel=&quot;shortcut icon&quot; href=&quot;http://getfoxyproxy.org/favicon.ico&quot;/&gt;&lt;link rel=&quot;stylesheet&quot; href=&quot;http://getfoxyproxy.org/styles/log.css&quot; type=&quot;text/css&quot;/&gt;&lt;/head&gt;&lt;body&gt;&lt;table class=&quot;log-table&quot;&gt;&lt;thead&gt;&lt;tr&gt;&lt;td class=&quot;heading&quot;&gt;${timestamp-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${url-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${proxy-name-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${proxy-notes-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${pattern-name-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${pattern-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${pattern-case-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${pattern-type-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${pattern-color-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${pac-result-heading}&lt;/td&gt;&lt;td class=&quot;heading&quot;&gt;${error-msg-heading}&lt;/td&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tfoot&gt;&lt;tr&gt;&lt;td/&gt;&lt;/tr&gt;&lt;/tfoot&gt;&lt;tbody&gt;"),k.setAttribute("row","&lt;tr&gt;&lt;td class=&quot;timestamp&quot;&gt;${timestamp}&lt;/td&gt;&lt;td class=&quot;url&quot;&gt;&lt;a href=&quot;${url}&quot;&gt;${url}&lt;/a&gt;&lt;/td&gt;&lt;td class=&quot;proxy-name&quot;&gt;${proxy-name}&lt;/td&gt;&lt;td class=&quot;proxy-notes&quot;&gt;${proxy-notes}&lt;/td&gt;&lt;td class=&quot;pattern-name&quot;&gt;${pattern-name}&lt;/td&gt;&lt;td class=&quot;pattern&quot;&gt;${pattern}&lt;/td&gt;&lt;td class=&quot;pattern-case&quot;&gt;${pattern-case}&lt;/td&gt;&lt;td class=&quot;pattern-type&quot;&gt;${pattern-type}&lt;/td&gt;&lt;td class=&quot;pattern-color&quot;&gt;${pattern-color}&lt;/td&gt;&lt;td class=&quot;pac-result&quot;&gt;${pac-result}&lt;/td&gt;&lt;td class=&quot;error-msg&quot;&gt;${error-msg}&lt;/td&gt;&lt;/tr&gt;"),k.setAttribute("footer","lt;/tbody&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;");var l={enabled:!1,temp:!1,reload:!0,notify:!0,notifyWhenCanceled:!0,prompt:!0},m=b.createElement("autoadd");for(c in l)m.setAttribute(c,l[c]);var n=b.createElement("quickadd");n.setAttribute("enabled",!1),n.setAttribute("temp",!1),n.setAttribute("reload",!0),n.setAttribute("notify",!0),n.setAttribute("notifyWhenCanceled",!0),n.setAttribute("prompt",!0);var o={enabled:!0,name:"Dynamic AutoAdd Pattern",pattern:"*://${3}${6}/*",isRegEx:!1,isBlackList:!1,isMultiLine:!1,caseSensitive:!1,fromSubscription:!1},p=b.createElement("match");for(c in o)p.setAttribute(c,o[c]);m.appendChild(p);var q={enabled:!0,name:"",pattern:"*You are not authorized to view this page*",isRegEx:!1,isBlackList:!1,isMultiLine:!1,caseSensitive:!1,fromSubscription:!1},r=b.createElement("match");for(c in q)r.setAttribute(c,q[c]);m.appendChild(r);var s={enabled:!0,name:"Dynamic AutoAdd Pattern",pattern:"*://${3}${6}/*",isRegEx:!1,isBlackList:!1,isMultiLine:!1,caseSensitive:!1,fromSubscription:!1},t=b.createElement("match");for(c in s)t.setAttribute(c,s[c]);n.appendChild(t);var u=b.createElement("defaultPrefs");u.setAttribute("origPrefetch",0),d=b.createElement("warnings"),d.setAttribute("white-patterns",!0),a.appendChild(f),a.appendChild(h),a.appendChild(j),a.appendChild(k),a.appendChild(m),a.appendChild(n),a.appendChild(u),a.appendChild(d)},generateXMLForPatterns=function(a,b){var c,d,e,f,g=0;if(b){for(e=a.createElement("matches"),g=0,c=b.length;c>g;g++)d=b[g].data,f=a.createElement("match"),f.setAttribute("enabled",d.enabled),f.setAttribute("name",d.name),"wildcard"!=d.type?f.setAttribute("isRegex",!0):f.setAttribute("isRegex",!1),f.setAttribute("pattern",d.url),f.setAttribute("reload",!0),f.setAttribute("autoReload",!1),"Inclusive"==d.whitelist?f.setAttribute("isBlackList",!1):f.setAttribute("isBlackList",!0),f.setAttribute("isMultiLine",!1),f.setAttribute("fromSubscription",!1),f.setAttribute("caseSensitive",!1),e.appendChild(f);return e}return null},setSingleProxyNode=function(a,b){var c,d,e,f=a.createElement("proxy");return f.setAttribute("name",b.name),f.setAttribute("id",b.id),f.setAttribute("notes",b.notes),f.setAttribute("enabled",b.enabled),"default"==b.id?f.setAttribute("color","#0055E5"):f.setAttribute("color",b.color),f.setAttribute("mode",b.type),f.setAttribute("autoconfMode","pac"),"default"==b.id?f.setAttribute("lastresort",!0):f.setAttribute("lastresort",!1),c=a.createElement("manualconf"),c.setAttribute("host",b.host),c.setAttribute("port",b.port),c.setAttribute("socksversion",b.socks),b.isSocks?c.setAttribute("isSocks",!0):c.setAttribute("isSocks",!1),f.appendChild(c),d=a.createElement("autoconf"),d.setAttribute("url",b.configUrl),d.setAttribute("reloadPac",!1),d.setAttribute("loadNotification",!0),d.setAttribute("errorNotification",!0),d.setAttribute("autoReload",!1),d.setAttribute("reloadFreqMins","60"),d.setAttribute("disableOnBadPAC",!0),f.appendChild(d),b.patterns&&(e=generateXMLForPatterns(a,b.patterns),e&&f.appendChild(e)),f},generateXMLFromStorage=function(){var a=document.implementation.createDocument(null,null,null),b=a.createElement("foxyproxy");setDefaultFoxyProxySettings(b,a);for(var c,d,e=a.createElement("proxies"),f=list,g=f.length,h=0;g>h;h++)c=f[h].data,d=setSingleProxyNode(a,c),e.appendChild(d);return a.appendChild(b),b.appendChild(e),a},exportAndDownload=function(){var a=generateXMLFromStorage(),b=(new XMLSerializer).serializeToString(a),c=new Blob(['<?xml version="1.0" encoding="UTF-8"?>'+b]),d=document.createEvent("HTMLEvents");d.initEvent("click"),$("<a>",{download:"FoxyProxy-export.fpx",href:webkitURL.createObjectURL(c)}).get(0).dispatchEvent(d)};$(document).ready(function(){var a=$("#export-to-file");a.click(function(){exportAndDownload()})});