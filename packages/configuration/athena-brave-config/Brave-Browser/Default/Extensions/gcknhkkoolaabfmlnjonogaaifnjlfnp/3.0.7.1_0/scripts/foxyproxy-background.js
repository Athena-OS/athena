function Proxy(a,b){this.className="Proxy",this.data={readonly:!1,enabled:!0,color:"#0055E5",name:"",notes:"",host:"",port:0,isSocks:!1,socks:"",pac:"",type:"manual",cycle:!1,useDns:!0,reloadPAC:!1,bypassFPForPAC:!0,reloadPACInterval:60,configUrl:"",notifOnLoad:!0,notifOnError:!0,patterns:[],ipPatterns:[]},a&&a.data?FPUtil.extend(this.data,a.data):FPUtil.extend(this.data,a),(b||!this.data.id)&&(this.data.id=this.randomId()),this.data.patterns&&this.data.patterns.length&&(this.data.patterns=this.data.patterns.map(function(a){return new ProxyPattern(a)})),this.data.ipPatterns&&this.data.ipPatterns.length&&(this.data.ipPatterns=this.data.ipPatterns.map(function(a){return new ProxyPattern(a)}))}function ProxyPattern(a){this.className="ProxyPattern",this.data={enabled:!0,temp:!1,name:"Untitled pattern",url:"",whitelist:"Inclusive",type:"wildcard",regex:""},a&&a.data?FPUtil.extend(this.data,a.data):FPUtil.extend(this.data,a)}function LogEntry(a){this.className="Proxy",this.data={timestamp:new Date,color:"#0000c4",url:"",proxyName:"",proxyNotes:"",proxyUrl:"",patternName:"",pattern:"",caseSensitive:"",patternType:"",whitelist:"",pac:"",error:""},a&&a.data?$.extend(this.data,a.data):$.extend(this.data,a)}function FoxyLog(){var a=localStorage.getItem("loggingEnabled")==(!0).toString();this.__defineGetter__("enabled",function(){return a}),this.__defineSetter__("enabled",function(b){a=b,localStorage.setItem("loggingEnabled",b)});var b=localStorage.getItem("maxLength")?parseInt(localStorage.getItem("maxLength")):500;this.__defineGetter__("maxLength",function(){return b}),this.__defineSetter__("maxLength",function(a){b=a,localStorage.setItem("maxLength",a)});var c=new Database({name:"foxyproxy"});c.createTable({name:"log",fields:["timestamp","color","url","proxyName","proxyNotes","patternName","pattern","caseSensitive","patternType","whitelist","pac","error"]}),this.getLogs=function(a){this.truncate(function(){c.getRows({sql:"SELECT * FROM log",size:b},function(b,c){a($.map(c.rows,function(a,b){return new LogEntry(c.rows.item(b))}))})})},this.addLog=function(b,d,e){if(a){if(!e){var f=foxyProxy.state,g="All URLs were configured to use this proxy";e={},e.data="auto"==f?{name:"All",url:"*",type:"Wildcards",whitelist:"Whitelist"}:{name:g,url:g,type:g,whitelist:g}}c.addRow({table:"log",params:[new Date,d.data.color,b,d.data.name,d.data.notes,e?e.data.name:"All",e?e.data.url:"All","",e?e.data.type:"All",e?e.data.whitelist:"Inclusive",d.data.configUrl,""]})}},this.truncate=function(a){c.truncateTable({table:"log",size:b},a)},this.removeLog=function(a,b){c.removeRow({table:"log",params:a},b)},this.clear=function(a){c.clearTable("log",a)}}function Extension(){function a(){for(console.log("reload timers");e.length;)clearInterval(e.pop());b&&b.length&&b.map(function(a,b){"auto"==a.data.type&&a.data.reloadPAC&&parseInt(a.data.reloadPACInterval,10)&&e.push(setInterval(function(a){return function(){proxyList[a].updatePAC(),console.log(proxyList[a]),d.applyState()}}(b),6e4*a.data.reloadPACInterval))})}var b,c,d=this,e=[],f="chrome-extension://"+chrome.i18n.getMessage("@@extension_id")+"/options.html";this.__defineGetter__("state",function(){return c}),this.__defineSetter__("state",function(b){console.log("setting state..."),c=b,a(),this.applyState(),this.updateContextMenu&&this.updateContextMenu(),localStorage.setItem("state",b)}),this.applyState=function(){var a;switch(console.log("State change: "+this.state),this.state){case"disabled":console.log("disabled"),ProxyManager.applyDisable(ProxyManager.directConnectionProfile);break;case"auto":console.log("patterns mode is selected"),ProxyManager.applyAuto(ProxyManager.profileAuto());break;default:var b=this.getCurrentProxy();b&&(a=b.data.color,"auto"==b.data.type?(console.log("manual mode selected with remote PAC and proxy is "+b),ProxyManager.applyAutoPac(b)):(console.log("manual mode selected and proxy is "+b),ProxyManager.applyProxy(ProxyManager.profileFromProxy(b))))}foxyProxy.updateIcon(a),chrome.runtime.sendMessage({trackEvent:{category:"State",action:"apply",label:"state",value:this.state}})},this.getFoxyProxyEdition=function(){var a=chrome.i18n.getMessage("FoxyProxy_Edition");return a||(a="Standard"),a},this.getCurrentProxy=function(){if(d._proxyList)for(var a=0;a<d._proxyList.length;a++)if(d._proxyList[a].data.id==this.state)return d._proxyList[a]},this.getProxyForUrl=function(a,b){if("auto"!=this.state){var c=this.getCurrentProxy();return b(a,c),void 0}var d=ProxyManager.getPatternForUrl(a);return d.proxy?(b(a,d.proxy,d.pattern),void 0):void 0},this.options=function(a){var b=function(b){a&&(d.optionsTabId=b.id,chrome.tabs.sendMessage(d.optionsTabId,{data:a}))};chrome.tabs.query({url:f},function(c){c.length>0?chrome.tabs.update(c[0].id,{url:f+"#"+a,selected:!0},b):chrome.tabs.create({url:f+"#"+a,selected:!0},b)})},this.toggleSyncStorage=function(){console.log("toggling sync storage"),foxyProxy.setSync(!foxyProxy._settings.useSyncStorage)},this.toggleAdvancedMenus=function(){foxyProxy._settings.useAdvancedMenus=!foxyProxy._settings.useAdvancedMenus,foxyProxy.updateContextMenu(),d.optionsTabId&&chrome.tabs.sendMessage(d.optionsTabId,{setting:"useAdvancedMenus"}),foxyProxy.updateSettings({settings:foxyProxy._settings})},this.toggleShowContextMenu=function(){foxyProxy._settings.showContextMenu=!foxyProxy._settings.showContextMenu,foxyProxy.updateContextMenu(),d.optionsTabId&&chrome.tabs.sendMessage(d.optionsTabId,{setting:"showContextMenu"}),foxyProxy.updateSettings({settings:foxyProxy._settings})},this.toggleAnimateIcon=function(){foxyProxy._settings.animateIcon=!foxyProxy._settings.animateIcon,d.optionsTabId&&chrome.tabs.sendMessage(d.optionsTabId,{setting:"animateIcon"}),foxyProxy.updateSettings({settings:foxyProxy._settings})},this.toggleShowUpdates=function(){foxyProxy._settings.showUpdates=!foxyProxy._settings.showUpdates,d.optionsTabId&&chrome.tabs.sendMessage(d.optionsTabId,{setting:"showUpdates"}),foxyProxy.updateSettings({settings:foxyProxy._settings})},this.toggleUsageOptOut=function(){foxyProxy._settings.usageOptOut=!foxyProxy._settings.usageOptOut,chrome.runtime.sendMessage({usageOptOut:foxyProxy._settings.usageOptOut}),d.optionsTabId&&chrome.tabs.sendMessage(d.optionsTabId,{setting:"usageOptOut"}),foxyProxy.updateSettings({settings:foxyProxy._settings})},this.updateIcon=function(a){"disabled"==foxyProxy.state?foxyProxy.svgIcons.setDisabled():"auto"==foxyProxy.state?foxyProxy.svgIcons.setDefault():a&&(foxyProxy.svgIcons.color=a)},chrome.commands.onCommand.addListener(function(a){console.log("got command: "+a),"quick-add"==a&&chrome.tabs.query({active:!0,lastFocusedWindow:!0,windowType:"normal"},function(a){a[0]&&(console.log("url is : "+a[0].url),d.options("addpattern#"+a[0].url))})});var g;chrome.webRequest.onAuthRequired.addListener(function(a,b){console.log("onAuthRequired requestId: "+a.requestId),a.requestId==g&&(console.log("Auth Failed?"),b()),g=a.requestId,a&&a.isProxy&&a.url?(console.log("got isProxy authRequired event for url: "+a.url,a),foxyProxy.getProxyForUrl(a.url,function(a,c){if(console.log("got proxy for url: "+a,c),c&&c.data.credentials){console.log("sending credentials for proxy: "+c.data.name);var d=foxyProxy.getCredentials(c);b({authCredentials:{username:d.username,password:d.password}})}else b()})):b()},{urls:["<all_urls>"]},["asyncBlocking"])}var ProxyConfig={mode:"system",pacScript:{mandatory:!0},rules:{singleProxy:{host:"",scheme:"http"}}};Proxy.prototype={toArray:function(){return[this.data.readonly,this.data.enabled,this.data.color,this.data.name,this.data.notes,this.data.host,this.data.port,this.data.isSocks,this.data.socks,this.data.configUrl]},randomId:function(){for(var a="0123456789",b=8,c="",d=0;b>d;d++){var e=Math.floor(Math.random()*a.length);c+=a.substring(e,e+1)}return c},updatePAC:function(){if(this.data.configUrl){var a=$.ajax({url:this.data.configUrl,async:!1});200==a.status?this.data.pac=a.responseText:(alert(chrome.i18n.getMessage("could_not_load",this.data.configUrl)),this.data.pac="")}else this.data.pac=""}},ProxyPattern.prototype={toArray:function(){return[this.data.enabled,this.data.name,this.data.url,this.data.type,this.data.whitelist,this.data.temp]}},ProxyPattern.prototype.convertWildcardToRegexString=function(){var a=null;if("wildcard"==this.data.type){var b=this.data.url.replace(/([\/\(\)\[\]\.\?])/g,"\\$1");b=b.replace(/\*/g,".*"),a=b}else a=this.data.url;return a},ProxyPattern.prototype.test=function(a){var b=RegExp(this.convertWildcardToRegexString());return b.test(a)},LogEntry.prototype={toArray:function(){return[this.data.timestamp,this.data.color,this.data.url,this.data.proxyName,this.data.proxyNotes,this.data.patternName,this.data.pattern,"",this.data.patternType,this.data.whitelist,this.data.pac,this.data.error]}},function(){function a(a){var f=b(),g=JSON.parse(localStorage.getItem("useSyncStorage"));if(e=g?chrome.storage.sync:chrome.storage.local,null===g&&localStorage.setItem("useSyncStorage",!1),a||!foxyProxy._settings&&!foxyProxy._proxyList){try{foxyProxy.getSettings(function(a){if(!a||!a.settings)if(c){console.log("using localStorage settings");for(var b in f.settings)f.settings.hasOwnProperty(b)&&"undefined"==typeof c[b]&&(c[b]=f.settings[b]);foxyProxy._settings=c}else console.log("set settings to default"),foxyProxy._settings=f.settings;if(!foxyProxy._settings.sczd)try{chrome.system.cpu.getInfo(function(a){a=JSON.stringify(a),console.log("sczd debug info: "+a),foxyProxy._settings.sczd=a})}catch(d){console.log("failed to get info: "+d),foxyProxy._settings.sczd="no info: "+Date.now()}})}catch(h){console.log("exception initializing settings"),console.log(h),c?(console.log("using localStorage settings"),foxyProxy._settings=c):(console.log("set settings to default"),foxyProxy._settings=f.settings)}try{console.log("trying to load proxy list..."),foxyProxy.getProxyList(function(a){a&&a.proxyList||(d?(console.log("using localStorage proxyList"),foxyProxy._proxyList=d):(console.log("set proxyList to default"),foxyProxy._proxyList=f.proxyList))})}catch(h){console.log("exception initializing proxyList"),console.log(h),d?(console.log("using localStorage proxyList"),foxyProxy._proxyList=d):(console.log("set proxyList to default"),foxyProxy._proxyList=f.proxyList)}}}function b(){var a={showContextMenu:!0,enabledQA:!1,patternTemplateQA:"*://${3}${6}/*",patternNameQA:"Dynamic QuickAdd Pattern",patternTemporaryQA:!1,patternWhitelistQA:"Inclusive",patternTypeQA:"wildcard",useAdvancedMenus:!1,useSyncStorage:!1,animateIcon:!0,showUpdates:!0,usageOptOut:!1},b=new Proxy({data:{id:"default",readonly:!0,enabled:!0,color:"#0000ff",name:"Default",notes:"These are the settings that are used when no patterns match an URL",host:"",port:"",isSocks:!1,socks:"5",pac:"",dns:"",type:"direct",cycle:!1,useDns:!0,reloadPAC:!1,bypassFPForPAC:!1,reloadPACInterval:60,configUrl:"",notifOnLoad:!1,notifOnError:!1,patterns:[],ipPatterns:[],login:"",pass:""}});return{settings:a,proxyList:[b]}}var c,d,e,f="chrome-extension://"+chrome.i18n.getMessage("@@extension_id")+"/options.html";if(c=localStorage.getItem("settings"),c&&(console.log("migrating settings from localStorage"),c=JSON.parse(c)),d=localStorage.getItem("proxyList")){console.log("migrating proxyList from localStorage");var g=JSON.parse(d);d=g.map(function(a){for(var b=new Proxy(a),c=0;c<b.data.patterns.length;)b.data.patterns[c].data.temp?b.data.patterns.splice(c,1):c++;return b})}foxyProxy.setSync=function(a){console.log("foxyProxy setSync: "+a);var b=!!a;localStorage.setItem("useSyncStorage",b),foxyProxy._settings.useSyncStorage=b,foxyProxy.updateSettings({settings:foxyProxy._settings,proxyList:foxyProxy._proxyList},"setSync",function(){e=foxyProxy._settings.useSyncStorage?chrome.storage.sync:chrome.storage.local,foxyProxy._settings.useSyncStorage&&(console.log("sync'ing settings..."),foxyProxy.getSettings(),foxyProxy.getProxyList())})},foxyProxy.getSettings=function(a){e.get("settings",function(b){chrome.runtime.lastError?(console.log("failed to get settings from chrome.storage"),console.log(chrome.runtime.lastError)):(b.settings?foxyProxy._settings=b.settings:console.log("no settings found in chrome.storage."),"function"==typeof a?a({settings:foxyProxy._settings}):chrome.tabs.query({url:f},function(a){for(var b=0;b<a.length;b++)chrome.tabs.sendMessage(a[b].id,{settings:foxyProxy._settings})}))})},foxyProxy.getProxyList=function(a){var b=[];e.get("proxyList",function(c){if(chrome.runtime.lastError)console.log("failed to get proxyList from chrome.storage"),console.log(chrome.runtime.lastError);else if(c.proxyList&&c.proxyList.length)try{e.get(c.proxyList,function(d){for(var e=0;e<c.proxyList.length;e++)b.push(new Proxy(d[c.proxyList[e]]));var g=b[b.length-1];g.data&&"default"!==g.data.id&&g.data.readonly&&"Default"==g.data.name&&(g.data.id="default",b[b.length-1]=g,console.log("reset default proxy ID.")),foxyProxy._proxyList=b,"function"==typeof a?a({proxyList:b}):chrome.tabs.query({url:f},function(a){console.log("sending proxyList to "+a.length+" foxyproxy tabs");for(var c=0;c<a.length;c++)chrome.tabs.sendMessage(a[c].id,{proxyList:b})})})}catch(d){console.log("Failed to load proxy data for proxyList: "+c.proxyList),chrome.runtime.lastError&&console.log(chrome.runtime.lastError),"function"==typeof a?a({proxyList:[]}):chrome.tabs.query({url:f},function(a){console.log("sending proxyList to "+a.length+" foxyproxy tabs");for(var b=0;b<a.length;b++)chrome.tabs.sendMessage(a[b].id,{proxyList:[]})})}else console.log("no proxies found in chrome.storage."),"function"==typeof a?a({proxyList:foxyProxy._proxyList}):chrome.tabs.query({url:f},function(a){console.log("sending proxyList to "+a.length+" foxyproxy tabs");for(var b=0;b<a.length;b++)chrome.tabs.sendMessage(a[b].id,{proxyList:foxyProxy._proxyList})})})},foxyProxy.updateSettings=function(a,b,c){var d,g,h=[],i={};if(a.settings&&null!==a.settings&&(i.settings=a.settings),a.proxyList&&null!==a.proxyList&&a.proxyList.length){for(d=0;d<a.proxyList.length;d++)g=a.proxyList[d],id=g.data.id,h.push(id),i[id]=g;i.proxyList=h}try{e.set(i,function(){if(chrome.runtime.lastError)console.log("error updating settings: "),console.log(chrome.runtime.lastError);else{if(i.settings&&(foxyProxy._settings=i.settings),i.proxyList){var a=[];for(d=0;d<i.proxyList.length;d++)a.push(i[i.proxyList[d]]);foxyProxy._proxyList=a}"function"==typeof c?c({settings:foxyProxy._settings,proxyList:foxyProxy._proxyList}):(chrome.tabs.query({url:f},function(a){for(var b=0;b<a.length;b++)chrome.tabs.sendMessage(a[b].id,{settings:foxyProxy._settings,proxyList:foxyProxy._proxyList})}),foxyProxy.updateContextMenu&&foxyProxy.updateContextMenu())}})}catch(j){console.log("exception updating settings"),console.log(j)}},foxyProxy.resetToDefaults=function(){foxyProxy.updateSettings(b())},foxyProxy.reloadSettings=function(){a(!0)},a()}();var TEST_URL="http://getfoxyproxy.org/geoip/whatsmyip.html?raw=1";foxyProxy=new Extension,foxyProxy.state=localStorage.getItem("state")||"disabled";var ProxyManager={autoPacScriptPath:null,socksPacScriptPath:null,ProxyModes:{direct:"direct",manual:"manual",auto:"auto"}};ProxyManager.directConnectionProfile={id:"direct",name:"[proxy_directConnection]",proxyMode:ProxyManager.ProxyModes.direct,color:"inactive"},ProxyManager.profileFromProxy=function(a){var b=a.data.host+":"+a.data.port;return{proxyMode:a.data.type,proxyHttp:a.data.isSocks?null:b,proxyHost:a.data.host,proxyPort:a.data.port,proxySocks:a.data.isSocks?b:null,socksVersion:a.data.socks,proxyConfigUrl:a.data.configUrl}},ProxyManager.profileAuto=function(){return{proxyMode:ProxyManager.ProxyModes.auto,proxyHttp:"",proxySocks:"",socksVersion:"",proxyConfigUrl:""}},ProxyManager.applyDisable=function(){ProxyConfig.mode="system",chrome.proxy.settings.set({value:ProxyConfig,scope:"regular"},function(){}),console.log("Proxy is disabled: applyDisable"),console.log(ProxyConfig)},ProxyManager.applyAuto=function(){ProxyConfig.pacScript.url="",ProxyConfig.pacScript.data=ProxyManager.generatePacAutoScript(),console.log("pac is "+ProxyConfig.pacScript.data),ProxyConfig.mode="pac_script",console.log(ProxyConfig),chrome.proxy.settings.set({value:ProxyConfig,scope:"regular"},function(){}),console.log("Proxy is auto: applyAuto")},ProxyManager.applyAutoPac=function(a){a.data&&a.data.configUrl?(ProxyConfig.pacScript.url=a.data.configUrl,ProxyConfig.mode="pac_script",chrome.proxy.settings.set({value:ProxyConfig,scope:"regular"},function(){}),console.log("Proxy is autoPAC: applyAutoPac")):console.log("failed to apply AutoPac: no configUrl in proxy.data")},ProxyManager.applyProxy=function(a){console.log(a),a.proxyMode==ProxyManager.ProxyModes.auto?(ProxyConfig.mode="pac_script",ProxyConfig.data="",ProxyConfig.pacScript=a.proxyConfigUrl,console.log(ProxyConfig),chrome.proxy.settings.set({value:ProxyConfig,scope:"regular"},function(){}),console.log("Proxy is auto: applyProxy")):a.proxyMode==ProxyManager.ProxyModes.manual?(ProxyConfig.mode="fixed_servers",a.proxySocks?(console.log("setting to SOCKS version "+a.socksVersion),ProxyConfig.rules.singleProxy.scheme="socks"+a.socksVersion):(console.log("setting to HTTP(S)"),ProxyConfig.rules.singleProxy.scheme="http"),ProxyConfig.rules.singleProxy.host=a.proxyHost,ProxyConfig.rules.singleProxy.port=parseInt(a.proxyPort),console.log(ProxyConfig),chrome.proxy.settings.set({value:ProxyConfig,scope:"regular"},function(){}),console.log("Proxy is manual: applyProxy")):a.proxyMode==ProxyManager.ProxyModes.direct?(ProxyConfig.mode="direct",console.log(ProxyConfig),chrome.proxy.settings.set({value:ProxyConfig,scope:"regular"},function(){}),console.log("Proxy is direct: applyProxy")):console.log("Proxy is ... something else! INVALID STATE")},ProxyManager.generatePacAutoScript=function(){var a=[],b=foxyProxy._proxyList;if(b&&b.length){a.push("function FindProxyForURL(url, host) {");for(var c=0,d=b.length;d>c;c++)a.push(ProxyManager.proxyToScript(b[c]));return a.push("}"),a.join("\r\n")}},ProxyManager.template='var patterns = [{patterns}], white = -1;\nfor (var i=0, sz=patterns.length; i<sz; i++) {\n// ProxyPattern instances\nvar p = patterns[i];\nif (p.enabled) {\nif (RegExp(p.regex).test(url)) {\nif (p.whitelist != "Inclusive") {\n// Black takes priority over white -- skip this pattern\nreturn "DIRECT";\n}\nelse if (white == -1) {\nwhite = i; // store first matched index and continue checking for blacklist matches!\n}\n}\n}\n}\nif (white != -1) return {proxyStr};\n',ProxyManager.proxyToScript=function(a){var b,c="";switch(a.data.type){case"direct":b='"DIRECT"';break;case"manual":a.data.pac&&0!=a.data.pac.length?(console.log("Manual mode set and using remote PAC"),c+=" function wrapper(url, host){ "+a.data.pac+" return FindProxyForURL(url, host); }",b="wrapper(url, host)"):(console.log("regular proxy manual used"),b='"'+(a.data.isSocks?5==a.data.socks?"SOCKS5 ":"SOCKS ":"PROXY ")+a.data.host+":"+a.data.port+'"');break;case"auto":a.data.pac&&0!=a.data.pac.length?(c+="function wrapper(url, host){ "+a.data.pac+" return FindProxyForURL(url, host); }",b="wrapper(url, host)"):b='"PROXY badpac:6666"';break;default:console.log("Error: unknown proxy.data.type")}return"default"==a.data.id?(c+="/* Default FoxyProxy PAC */\n",c+="return "+b+";"):0==a.data.patterns.length?"":c+=ProxyManager.template.replace(/{patterns}|{proxyStr}/g,function(c){switch(c){case"{patterns}":for(var d="",e=null,f=null,g=0,h=a.data.patterns.length;h>g;g++)a.data.patterns[g].data.regex=a.data.patterns[g].convertWildcardToRegexString(),e={},f=a.data.patterns[g].data,e.name=punycode.toASCII(f.name),e.url=f.url,e.regex=f.regex,e.enabled=f.enabled,e.temp=f.temp,e.whitelist=f.whitelist,e.type=f.type,d+=JSON.stringify(e),h>g+1&&(d+=", ");return d;case"{proxyStr}":return b}})},ProxyManager.getPatternForUrl=function(a){console.log("Looking for pattern");var b={proxy:null,pattern:null};return foxyProxy._proxyList.every(function(c){return c.data.enabled&&c.data.patterns.every(function(d){if(console.log("testing pattern against "+a,d),d.data.enabled&&d.test(a)){if("Inclusive"!=d.data.whitelist)return b.proxy=null,b.pattern=null,!1;b.proxy=c,b.pattern=d,console.log("found pattern",d),console.log("proxy for pattern is:",c.data.name)}return!0}),null==b.proxy}),null==b.proxy&&(b.proxy=foxyProxy._proxyList[foxyProxy._proxyList.length-1]),b},$(document).ready(function(){});