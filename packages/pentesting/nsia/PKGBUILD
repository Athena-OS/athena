# Credits BlackArch ( https://www.blackarch.org/ ).
# See COPYING for license details.

pkgname=nsia
pkgver=1.0.6
pkgrel=4
pkgdesc='A website scanner that monitors websites in realtime in order to detect defacements, compliance violations, exploits, sensitive information disclosure and other issues.'
url='http://threatfactor.com/Products/'
groups=('athena' 'athena-scanner' 'athena-webapp' 'athena-defensive')
arch=('any')
license=('custom:nsia')
depends=('java-environment' 'swt' 'systemd' 'libstdc++5')
makedepends=('dos2unix')
install="$pkgname.install"
source=('git+https://github.com/LukeMurphey/nsia'
        'NSIA.Definitions'
        'nsia.tmpfiles.conf')
sha512sums=('SKIP'
            '0661e777bb5cabb45637fa07cadcb8d1cb09bd2d4c24b56dbde077f0ebc8a0807d7328a8eeeec749e7e31dd12fbcc9360028aede1bf454b307f3d690740b04f6'
            '525021f021ae662d0a49f27e62dcbbbe69fe441e9388414c9be4cd15c3dfac42f7bfa9aa7941eba7a466a1e6dc5ad79661d1f83362127657796c1e4749bb4666')

pkgver() {
  cd $pkgname

  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

prepare() {
  dos2unix etc/config.ini

  rm lib/swt.jar
}

package() {
  unset _JAVA_OPTIONS

  install -dm 755 "$pkgdir/usr/bin"
  install -dm 755 "$pkgdir/var/lib/$pkgname/var"

  install -Dm 644 nsia.tmpfiles.conf "$pkgdir/usr/lib/tmpfiles.d/nsia.conf"
  install -Dm 644 -t "$pkgdir/usr/share/nsia/doc" doc/"Quick Start Guide.pdf" \
    doc/AUTHORS NSIA.Definitions
  install -Dm 644 doc/LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
  install -Dm 644 bin/nsia.jar "$pkgdir/usr/share/$pkgname/bin/nsia.jar"
  install -Dm 644 etc/config.ini "$pkgdir/usr/share/$pkgname/etc/config.ini"
  install -Dm 644 etc/mime.types "$pkgdir/usr/share/$pkgname/etc/mime.types"
  install -Dm 644 rhino.jar "$pkgdir/usr/share/$pkgname/lib/rhino.jar"

  find lib -type f -exec install -Dm644 '{}' "$pkgdir"/usr/share/nsia/'{}' \;

  ln -s /usr/share/java/swt.jar "$pkgdir/usr/share/nsia/lib/swt.jar"

  echo -e '#!/usr/bin/env bash\n\nunset _JAVA_OPTIONS\n\ncd /var/lib/nsia/var\njava -Xbootclasspath/p:../lib/rhino.jar -jar /usr/share/nsia/bin/nsia.jar "$@"' > "$pkgdir/usr/bin/nsia"

  chmod +x "$pkgdir/usr/bin/$pkgname"
}

