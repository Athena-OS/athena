# Maintainer: Jo√£o Figueiredo <islandc0der@chaotic.cx>
# Contributor: Jan de Groot <jan@archlinux.org>

pkgname=gconf
pkgver=3.2.6+11+g07808097
pkgrel=11
pkgdesc='An obsolete configuration database system'
url='https://projects-old.gnome.org/gconf/'
arch=('x86_64' 'aarch64')
license=('LGPL')
depends=('libxml2' 'polkit' 'libldap' 'dbus-glib' 'python')
makedepends=('git' 'intltool' 'gtk-doc' 'gobject-introspection' 'gnome-common' 'glib2-devel')
install=gconf.install
_commit=0780809731c8ab1c364202b1900d3df106b28626 # The latest and last commit, dug out from deep within the waves of time...
source=("git+https://gitlab.gnome.org/Archive/gconf.git#commit=$_commit"
        "01_xml-gettext-domain.patch"
        "gconf-reload.patch"
        "gconf-merge-schema"
        "gconfpkg"
        "gconf-install.hook"
        "gconf-remove.hook"
        "gsettings-schema-convert.patch")
sha512sums=('1b7c0263581710f5bbe6155938b37e1bc42eb79a91e84caae3df5c3bee9adbe5225401873fc11d86f73102590d11394384b8a295e8cac613d576152009bb3e79'
            '08c2bb7872816ec8a272bf393793167b2e2a285ede419f1385380bda34b55cdb08f9d5599714960407ad3549f1b03590ca39b3511ba33eec5aeea33d37521b5f'
            '1af1d0c926d622794b5d2f21646783c276a8a5c2c6d8b8236804bfcaeb71ab40c6658b17eb4599ca01fb8fe33a513ebe7ec9e8c23e9a21ccae622f6d10aa5657'
            '0d2a099c772c9fbe535b6c5c35078038987d214a2b68f2d589f46b8bf4e5a8c604624363cd32747b6447d04037d2fb0870502982425629af25ac3ef8ebb2cde4'
            'c1a180fdbd88415f4d0277919bdd3af8c1003e44f81a6ab7f7c341a4065f9e01e320e639177ad93d53463ceecb7f1331171980edabcebdc10998d7f16c490494'
            'b4c8f1a3dbb9edf6fde6e129a5673f4e47193fd77e4bdf669f1737e127e3aff9154ad3808780b9a983f6b2e43ff0c60a212b749d7190684b2a02cb0a4ac7dfc4'
            '563ac014f398022ae00d1bad9518a5c3387deb4794ac12e9e88ca3b66f51d65573fd7f7737be5e0444916473c5cf47cc70b74292c3fcf3f812411a57f25af8f9'
            '1ac33a89aa163e9e72ea88deb1afe2914f18430bda39e290815469bf86d7c516271df102d10b787b2736fb078b6ac26d06fe7de00473ebd1e6f6219cc1688477')

prepare() {
  cd $pkgname

  # Patch from fedora - reloads gconf after installing schemas
  patch -Np1 -i ../gconf-reload.patch

  # http://bugzilla.gnome.org/show_bug.cgi?id=568845
  patch -Np1 -i ../01_xml-gettext-domain.patch

  # The following line copied from Fedora
  # https://src.fedoraproject.org/rpms/GConf2/blob/70ed26d67b563d858a84505622d11f41879a6b37/f/GConf2.spec#_90
  #2to3-2.7 --write --nobackup gsettings/gsettings-schema-convert
  patch -Np1 -i ../gsettings-schema-convert.patch

  sed -i '1s|#!/usr/bin/env python$|#!/usr/bin/python|' gsettings/gsettings-schema-convert

  NOCONFIGURE=1 ./autogen.sh
}

build() {
  cd $pkgname
  ./configure \
    --prefix=/usr \
    --sysconfdir=/etc \
    --localstatedir=/var \
    --libexecdir=/usr/lib \
    --enable-defaults-service \
    --disable-gtk-doc \
    --disable-static \
    --disable-orbit
  sed -i -e 's/ -shared / -Wl,-O1,--as-needed\0/g' libtool
  make
}

check() {
  cd $pkgname
  make check
}

package() {
  DESTDIR="$pkgdir" make -C $pkgname install

  install -d "$pkgdir/etc/gconf/gconf.xml.system"
  install -D gconf-merge-schema gconfpkg -t "$pkgdir/usr/bin"
  install -Dm644 ./*.hook -t "$pkgdir/usr/share/libalpm/hooks"

  # fix dbus policy location - --with-dbusdir doesn't work
  install -Dm644 "$pkgdir/etc/dbus-1/system.d/org.gnome.GConf.Defaults.conf" -t "$pkgdir/usr/share/dbus-1/system.d"
  rm -rf "$pkgdir/etc/dbus-1/"
}

