From: Debian Security Tools <team+pkg-security@tracker.debian.org>
Date: Fri, 15 Oct 2021 12:10:59 +0200
Subject: Many Makefile improvements

Last-Update: 2016-06-24

- Use the proper CFLAGS/CPPFLAGS/LDFLAGS to benefit from hardening.
- Add an install target.
- Clean up all object files on make clean.
- Rename "netmask" to "inetmask" (see https://bugs.debian.org/176755)
Last-Update: 2016-06-24
---
 Makefile | 93 ++++++++++++++++++++++++++++++++++------------------------------
 1 file changed, 49 insertions(+), 44 deletions(-)

diff --git a/Makefile b/Makefile
index 16e9cc1..d973260 100644
--- a/Makefile
+++ b/Makefile
@@ -1,8 +1,12 @@
 # IRPAS Makefile
 
+# Inserted for Debian package
+DESTDIR =
+SBIN = $(DESTDIR)/usr/sbin/
+
 CLIBS= -lpcap 
-CFLAGS=-Wall -g -Wunused -Wmissing-prototypes -I. -L. \
-	-I./libpcap-0.4 -L./libpcap-0.4
+CFLAGS+=-Wall -g -Wunused -Wmissing-prototypes -I.
+LDFLAGS+= -L.
 CC=gcc
 RM=rm
 CP=cp
@@ -14,107 +18,108 @@ RELVER=`grep "Version" IRPAS.version | awk '{print $$4}'`
 
 OBJECTS= packets.o cdp.o igrp.o ass_v1.o irdp.o irdpresponder.o \
 	itrace.o tctrace.o protos.o netmask.o file2cable.o dfkaa.o netenum.o \
-	hsrp.o icmp_redirect.o timestamp.o dhcpx.o
+	hsrp.o icmp_redirect.o timestamp.o dhcpx.o enum.o libpackets.a
 PROGRAMS=cdp igrp ass irdp irdpresponder itrace tctrace protos \
-	netmask file2cable dfkaa netenum hsrp icmp_redirect timestamp dhcpx
+	inetmask file2cable dfkaa netenum hsrp icmp_redirect timestamp dhcpx
 
-all: libpc ${PROGRAMS} 
+all: ${PROGRAMS} 
 
-libpc:
-	( cd libpcap-0.4; ./configure && make )
 # programs
 dhcpx: dhcpx.o libpackets.a
-	${CC} ${CFLAGS} -o dhcpx dhcpx.o -lpackets -lpcap
+	${CC} ${LDFLAGS} -o dhcpx dhcpx.o -lpackets -lpcap
 dhcpx.o: dhcpx.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c dhcpx.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c dhcpx.c
 
 dfkaa: dfkaa.o libpackets.a
-	${CC} ${CFLAGS} -o dfkaa dfkaa.o -lpackets
+	${CC} ${LDFLAGS} -o dfkaa dfkaa.o -lpackets
 dfkaa.o: dfkaa.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c dfkaa.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c dfkaa.c
 
 netenum: netenum.o libpackets.a
-	${CC} ${CFLAGS} -o netenum netenum.o -lpackets
+	${CC} ${LDFLAGS} -o netenum netenum.o -lpackets
 netenum.o: netenum.c packets.h protocols.h enum.h 
-	${CC} ${CFLAGS} -c netenum.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c netenum.c
 
 hsrp: hsrp.o libpackets.a
-	${CC} ${CFLAGS} -o hsrp hsrp.o -lpackets
+	${CC} ${LDFLAGS} -o hsrp hsrp.o -lpackets
 hsrp.o: hsrp.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c hsrp.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c hsrp.c
 
 file2cable: file2cable.o libpackets.a
-	${CC} ${CFLAGS} -o file2cable file2cable.o -lpackets
+	${CC} ${LDFLAGS} -o file2cable file2cable.o -lpackets
 file2cable.o: file2cable.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c file2cable.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c file2cable.c
 
 cdp: cdp.o libpackets.a
-	${CC} ${CFLAGS} -o cdp cdp.o -lpackets
+	${CC} ${LDFLAGS} -o cdp cdp.o -lpackets
 cdp.o: cdp.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c cdp.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c cdp.c
 
 igrp: igrp.o libpackets.a
-	${CC} ${CFLAGS} -o igrp igrp.o -lpackets
+	${CC} ${LDFLAGS} -o igrp igrp.o -lpackets
 igrp.o: igrp.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c igrp.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c igrp.c
 
 timestamp: timestamp.o libpackets.a
-	${CC} ${CFLAGS} -o timestamp timestamp.o -lpackets
+	${CC} ${LDFLAGS} -o timestamp timestamp.o -lpackets
 timestamp.o: timestamp.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c timestamp.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c timestamp.c
 
-netmask: netmask.o libpackets.a
-	${CC} ${CFLAGS} -o netmask netmask.o -lpackets
+inetmask: netmask.o libpackets.a
+	${CC} ${LDFLAGS} -o inetmask netmask.o -lpackets
 netmask.o: netmask.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c netmask.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c netmask.c
 
 itrace: itrace.o libpackets.a
-	${CC} ${CFLAGS} -o itrace itrace.o -lpackets
+	${CC} ${LDFLAGS} -o itrace itrace.o -lpackets
 itrace.o: itrace.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c itrace.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c itrace.c
 
 tctrace: tctrace.o libpackets.a
-	${CC} ${CFLAGS} -o tctrace tctrace.o -lpackets
+	${CC} ${LDFLAGS} -o tctrace tctrace.o -lpackets
 tctrace.o: tctrace.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c tctrace.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c tctrace.c
 
 protos: protos.o libpackets.a
-	${CC} ${CFLAGS} -o protos protos.o -lpackets
+	${CC} ${LDFLAGS} -o protos protos.o -lpackets
 protos.o: protos.c packets.h protocols.h protocol-numbers.h 
-	${CC} ${CFLAGS} -c protos.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c protos.c
 
 irdp: irdp.o libpackets.a
-	${CC} ${CFLAGS} -o irdp irdp.o -lpackets
+	${CC} ${LDFLAGS} -o irdp irdp.o -lpackets
 irdp.o: irdp.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c irdp.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c irdp.c
 
 irdpresponder: irdpresponder.o libpackets.a
-	${CC} ${CFLAGS} -o irdpresponder irdpresponder.o -lpackets ${CLIBS}
+	${CC} ${LDFLAGS} -o irdpresponder irdpresponder.o -lpackets ${CLIBS}
 irdpresponder.o: irdpresponder.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c irdpresponder.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c irdpresponder.c
 
 icmp_redirect.o: icmp_redirect.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c icmp_redirect.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c icmp_redirect.c
 icmp_redirect: icmp_redirect.o libpackets.a 
-	${CC} ${CFLAGS} -o icmp_redirect icmp_redirect.o -lpackets ${CLIBS}
+	${CC} ${LDFLAGS} -o icmp_redirect icmp_redirect.o -lpackets ${CLIBS}
 
 ass_v1.o: ass_v1.c packets.h protocols.h 
-	${CC} ${CFLAGS} -c ass_v1.c
+	${CC} ${CFLAGS} ${CPPFLAGS} -c ass_v1.c
 ass: ass_v1.o libpackets.a 
-	${CC} ${CFLAGS} -o ass ass_v1.o -lpackets ${CLIBS}
+	${CC} ${LDFLAGS} -o ass ass_v1.o -lpackets ${CLIBS}
 assS: ass_v1.o libpackets.a
-	${CC} ${CFLAGS} -o assS ass_v1.o -lpackets ${CLIBS} -static
+	${CC} ${CFLAGS} ${CPPFLAGS} -o assS ass_v1.o -lpackets ${CLIBS} -static
 
 libpackets.a: packets.o enum.o 
 	$(AR) libpackets.a packets.o enum.o
 packets.o: packets.c  protocols.h
-	$(CC) ${CFLAGS} -c packets.c
+	$(CC) ${CFLAGS} ${CPPFLAGS} -c packets.c
 enum.o: enum.h enum.c 
-	$(CC) $(CFLAGS) -c enum.c
+	$(CC) $(CFLAGS) ${CPPFLAGS} -c enum.c
+
+install:
+	install -d ${SBIN}
+	install	${PROGRAMS} ${SBIN}
 
 clean:
 	${RM} -f ${OBJECTS}
-	( cd libpcap-0.4; make clean )
 
 realclean:
 	${RM} -f ${OBJECTS} ${PROGRAMS} 
