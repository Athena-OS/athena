--- wmi-1.3.16/Samba/source/wmi/wmis.c	2008-09-12 16:17:25.000000000 -0400
+++ wmi-1.3.16.patched/Samba/source/wmi/wmis.c	2012-04-30 22:07:45.531603783 -0400
@@ -64,7 +64,7 @@ static void parse_args(int argc, char *a
     pc = poptGetContext("wmi", argc, (const char **) argv,
 	        long_options, POPT_CONTEXT_KEEP_FIRST);
 
-    poptSetOtherOptionHelp(pc, "//host\n\nExample: wmis -U [domain/]adminuser%password //host");
+    poptSetOtherOptionHelp(pc, "//host\n\nExample: wmis -U [domain/]adminuser%password //host cmd.exe /c dir c:\\ > c:\\windows\\temp\\output.txt ");
 
     while ((opt = poptGetNextOpt(pc)) != -1) {
 	poptPrintUsage(pc, stdout, 0);
@@ -90,6 +90,8 @@ static void parse_args(int argc, char *a
     }
 
     pmyargs->hostname = argv_new[1] + 2;
+   pmyargs->query = argv_new[2];
+ 
     poptFreeContext(pc);
 }
 
@@ -127,7 +129,7 @@ WERROR WBEM_RemoteExecute(struct IWbemSe
 	result = IWbemServices_ExecMethod(pWS, ctx, "Win32_Process", "Create", 0, NULL, in, &out, NULL);
 	WERR_CHECK("IWbemServices_ExecMethod.");
 
-	if (ret_code) {
+if (ret_code) {
 		result = WbemClassObject_Get(out->object_data, ctx, "ReturnValue", 0, &v, 0, 0);
 		WERR_CHECK("IWbemClassObject_Put(CommandLine).");
 		*ret_code = v.v_uint32;
@@ -167,21 +169,9 @@ int main(int argc, char **argv)
 	result = WBEM_ConnectServer(ctx, args.hostname, "root\\cimv2", 0, 0, 0, 0, 0, 0, &pWS);
 	WERR_CHECK("WBEM_ConnectServer.");
 
-	DEBUG(0, ("1: Creating directory C:\\wmi_test_dir_tmp using method Win32_Process.Create\n"));
-	WBEM_RemoteExecute(pWS, "cmd.exe /C mkdir C:\\wmi_test_dir_tmp", &cnt);
-	WERR_CHECK("WBEM_RemoteExecute.");
-	DEBUG(0, ("2: ReturnCode: %d\n", cnt));
-
-	DEBUG(0, ("3: Monitoring directory C:\\wmi_test_dir_tmp. Please create/delete files in that directory to see notifications, after 4 events program quits.\n"));
-        result = IWbemServices_ExecNotificationQuery(pWS, ctx, "WQL", "SELECT * FROM __InstanceOperationEvent WITHIN 1 WHERE Targetinstance ISA 'CIM_DirectoryContainsFile' and TargetInstance.GroupComponent= 'Win32_Directory.Name=\"C:\\\\\\\\wmi_test_dir_tmp\"'", WBEM_FLAG_RETURN_IMMEDIATELY | WBEM_FLAG_FORWARD_ONLY, NULL, &pEnum);
-        WERR_CHECK("WMI query execute.");
-	for (cnt = 0; cnt < 4; ++cnt) {
-		struct WbemClassObject *co;
-		uint32_t ret;
-		result = IEnumWbemClassObject_SmartNext(pEnum, ctx, 0xFFFFFFFF, 1, &co, &ret);
-    		WERR_CHECK("IEnumWbemClassObject_Next.");
-		printf("%s\n", co->obj_class->__CLASS);
-	}
+	DEBUG(0, ("1: %s\n",args.query));
+	WBEM_RemoteExecute(pWS, args.query, &cnt);
+
 
 error:
 	status = werror_to_ntstatus(result);
