# Credits BlackArch ( https://www.blackarch.org/ ).
# See COPYING for license details.

pkgname=pth-toolkit
pkgver=7.3641cdc
pkgrel=2
pkgdesc='Modified version of the passing-the-hash tool collection made to work straight out of the box.'
groups=('athena' 'athena-sniffer' 'athena-networking')
arch=('x86_64')
url='https://github.com/byt3bl33d3r/pth-toolkit'
license=('BSD')
depends=('readline')
makedepends=('git')
source=("git+https://github.com/byt3bl33d3r/$pkgname.git"
        "curl-pth-ntlm.patch"
        "freetds-0.91-pth.patch"
        "moz-esr10-pth-test.patch"
        "moz-esr17-pth-test.patch"
        "moz-esr17-testpatch-nss"
        "samba4-4a18-pth.patch"
        "samba4-hash-any-link.patch"
        "wmi-1.3.16-smbencrypt.patch"
        "wmi-1.3.16-wmis.patch")
sha512sums=('SKIP'
            '6eda5f8dfcbe9a7b76a05fda9b90f91f63bca8b9105f25d13b3df70465a6bb159f772786dd8eb27e25714ad3c9a12c032d3d8de45f04255a8cd9efeeaa1cb93a'
            '3c4db33d4cf5d518c26975fc844f35f28dfbafcc59b4f8783d80c127f8c1805aeaaa3b5ce6b37bb9379168f8f2d4ac08fb03e43240ca289be27467fbf8662699'
            '298e9a00d0305493e05cc59024e9eebbfa50fa94ca5f8415bcb76164fd34b63274e0f5d633a89459789963d621564eeda09f32228d0a7b4fbb14cbbd90b8614b'
            'bacce86f82dc1e56d6f44fb9b96636ad618558b5e5dc4fc8485e9d6e639fb7901db421de56b5237a66dcc88c8891541f474bcf4fd10b997f9ca692cd193bbeb3'
            '3fa82ffe7eae6f82e67fe622e2294fcfc9d2baa33ee6bfdc32c1c6294c82f31f487efa77c12edb44474a1d832600f666e27a4b98fbdad41540225b943ab8bf80'
            '3908ee14d251a2569172d7434e99aa688c9a8b6c61cd1b18078ed8f813ed50db691089c442d279ae6b4ea2ed1981c19ff37869a619b50f9ee3d0c49886a6c042'
            '2691a754a2035c10703c9405d3cbd72a90065ad0b7e0d6a9576061576b28a21cc08d053659b1153ab2aed58e12cf66f5e327586998173bcc04a7b2de711decdd'
            '6cea41e4a662ff0aa0fdeca1ea4ae9f27c0c2c1e238bb6f9ff443694fa15459ee2542f948d7258f998150da42f600de709319c5aa8c13110f23845b128750936'
            '47396c90d2c4b16454e58d69a3832daf3bd295f31fc59f5bc71d09023bca5fcb28d70ad32aa17ad67ff9353a6c054a002347a925443572314566d12c54029248')

pkgver() {
  cd $pkgname

  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

prepare() {
  cd $pkgname

  patch -p1 < "$srcdir/curl-pth-ntlm.patch"
  patch -p1 < "$srcdir/freetds-0.91-pth.patch"
  patch -p1 < "$srcdir/moz-esr10-pth-test.patch"
  patch -p1 < "$srcdir/moz-esr17-pth-test.patch"
  patch -p1 < "$srcdir/moz-esr17-testpatch-nss"
  patch -p1 < "$srcdir/samba4-4a18-pth.patch"
  patch -p1 < "$srcdir/samba4-hash-any-link.patch"
  patch -p1 < "$srcdir/wmi-1.3.16-smbencrypt.patch"
  patch -p1 < "$srcdir/wmi-1.3.16-wmis.patch"
}

package() {
  cd $pkgname

  _tools="pth-net pth-rpcclient pth-smbclient pth-smbget pth-winexe"
  _tools="$_tools pth-wmic pth-wmis"

  install -dm 755 "$pkgdir/usr/bin"
  install -dm 755 "$pkgdir/usr/share/$pkgname"

  install -Dm 644 -t "$pkgdir/usr/share/doc/$pkgname/" README.md
  install -Dm 644 LICENSE.md "$pkgdir/usr/share/licenses/$pkgname/LICENSE.md"

  rm README.md LICENSE.md

  cp -a * "$pkgdir/usr/share/$pkgname/"

  for i in $_tools ; do
    cat > "$pkgdir/usr/bin/$i" << EOF
#!/bin/sh
cd /usr/share/$pkgname
exec ./$i "\$@"
EOF
    chmod +x "$pkgdir/usr/bin/$i"
  done
}

