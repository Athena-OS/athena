# Maintainer: Athena <team@athena.org>

buildarch=1

pkgname=windows-exploit-suggester-git
pkgver=20170217.r41
pkgrel=6
groups=('athena' 'athena-exploit')
arch=('any')
pkgdesc="Compares a target patch levels against the Microsoft vulnerability database to detect potential missing patches on the target. Also notifies the user if there are public exploits and Metasploit modules available for missing bulletins"
url="https://github.com/AonCyberLabs/Windows-Exploit-Suggester"
license=('GPL3')
depends=('python-xlrd')
makedepends=('git')
source=("${pkgname}::git+${url}.git"
        'updateTo3.patch')
sha512sums=('SKIP'
            'd9c516b1fa63442608cba915a5d7eb217ca5fc2d6d648bf721574b83cb6027630943d572f04a798baf074cee3648351382e739ee84e5b12bbe8d1bc808114c56')

prepare() {
    cd "${srcdir}/${pkgname}" || exit
    git apply "${srcdir}/updateTo3.patch"
}

pkgver() {
  cd "${srcdir}/${pkgname}" || exit
  printf "%s.r%s" "$(git show -s --format=%ci master | sed 's/\ .*//g;s/-//g')" "$(git rev-list --count HEAD)"
}

package() {
  cd "${srcdir}/${pkgname}" || exit
  install -dm755 "${pkgdir}/usr/bin"
  install -dm755 "${pkgdir}/usr/share/${pkgname}"
  install -Dm755 windows-exploit-suggester.py "${pkgdir}/usr/share/${pkgname}/windows-exploit-suggester"

cat > "${pkgdir}/usr/bin/windows-exploit-suggester" <<EOF
#!/bin/sh
cd "/usr/share/${pkgname}"
python windows-exploit-suggester "\$@"
EOF
chmod 755 "${pkgdir}/usr/bin/windows-exploit-suggester"
}
