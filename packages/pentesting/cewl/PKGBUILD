# Credits BlackArch ( https://www.blackarch.org/ ).
# See COPYING for license details.

pkgname=cewl
pkgver=171.6aea36a
pkgrel=1
groups=('role-bountyhunter' 'role-redteamer' 'role-student' 'role-cracker'
        'athena' 'athena-automation' 'athena-cracker')
pkgdesc='A custom word list generator.'
arch=('any')
url='http://www.digininja.org/projects/cewl.php'
license=('CCPL')
depends=('ruby' 'ruby-bundler' 'libxslt' 'perl-image-exiftool')
makedepends=('git')
source=("$pkgname::git+https://github.com/digininja/CeWL.git")
sha512sums=('SKIP')
install="$pkgname.install"

pkgver() {
  cd $pkgname

  echo $(git rev-list --count HEAD).$(git rev-parse --short HEAD)
}

prepare() {
  cd $pkgname

  rm -fv Gemfile.lock
  bundle config set --local path vendor/bundle
  bundle config set --local without development test
  bundle config build.nokogiri --use-system-libraries
  sed -i "s|require './cewl_lib'|require '/usr/share/cewl/cewl_lib'|g" cewl.rb
  # https://github.com/digininja/CeWL/pull/110
  sed -i "s|gem 'spider'|gem 'spider'\ngem 'json'|g" Gemfile
}

build() {
    cd $pkgname
    bundle install -j"$(nproc)"
}

package() {
  cd $pkgname

  install -dm 755 "$pkgdir/usr/bin"
  install -dm 755 "$pkgdir/usr/share/$pkgname"

  install -Dm 644 -t "$pkgdir/usr/share/doc/$pkgname/" README.md

  rm README.md

  cp -a * "$pkgdir/usr/share/$pkgname/"

    cat > "$pkgdir/usr/bin/$pkgname" << EOF
#!/bin/sh
BUNDLE_GEMFILE=/usr/share/$pkgname/Gemfile bundle exec /usr/share/$pkgname/$pkgname.rb "\$@"
EOF

  chmod +x "$pkgdir/usr/bin/$pkgname"

    cat > "$pkgdir/usr/bin/$pkgname-fab" << EOF
#!/bin/sh
BUNDLE_GEMFILE=/usr/share/$pkgname/Gemfile bundle exec /usr/share/$pkgname/fab.rb "\$@"
EOF

  chmod +x "$pkgdir/usr/bin/$pkgname-fab"

  cd "$pkgdir/usr/share/$pkgname/vendor/bundle/ruby/"*
  rm -rf cache extensions/*/*/*/{mkmf.log,gem_make.out}

  rm "$pkgdir/usr/share/$pkgname/Gemfile.lock" &&
    touch "$pkgdir/usr/share/$pkgname/Gemfile.lock"
}
