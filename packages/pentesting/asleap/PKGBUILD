# See COPYING for license details.

# Maintainer: Bryan Horna <bryanjhv@gmail.com>
# Contributor: Henning Mueller <henning@orgizm.net>

pkgname=asleap
pkgver=2.2
pkgrel=7
pkgdesc='Actively recover LEAP/PPTP passwords.'
arch=('x86_64' 'i686' 'armv6h' 'armv7h' 'aarch64')
url='https://www.willhackforsushi.com/?page_id=41'
license=('GPL-1.0-or-later')
depends=('libpcap' 'openssl')
source=("https://www.willhackforsushi.com/code/$pkgname/$pkgver/$pkgname-$pkgver.tgz"
        "libxcrypt.patch"
        "fixtimeout.patch")
noextract=("libxcrypt1.deb"
           "libxcrypt-dev.deb")
sha512sums=('123d624e2c3e0f6b8d4974947044adb68a5e4e307a9b1117e866c64f0e7df7ec22570eebebedea281ba60d3f37ff21a2581867f7ff3fdd9d3ad34e315bc14836'
            '8962737d6c69e7994f8b98ba3e1529bedb302a3cc844f856650f1fbf0c1342bb8a0eac12c27a234a22d592ed3d855fb278f899e17b7268f9182ff676ac2ffe22'
            '6f12284f057ff39a795d8c494091830e153418a4c68050d8ea1d61f061a5f561c84dcd21b1a921df4ee107e901db739b1cf59b9b30e69c2b6af270cee90fd6dc')

# Dynamically generate sources and skip sums
_arch=('amd64' 'i386' 'armel' 'armhf' 'arm64')
_repo="http://archive.debian.org/debian/pool/main/libx/libxcrypt/"
_vers="2.4-4"
_pkgs=("libxcrypt1" "libxcrypt-dev")
for _i in "${!arch[@]}"; do
	_darch="${arch[$_i]}"
	_sarch="${_arch[$_i]}"
	eval "source_$_darch"=\(\)
	eval "md5sums_$_darch"=\(\)
	for _p in "${_pkgs[@]}"; do
		eval "md5sums_$_darch"+=\("SKIP"\)
		eval "source_$_darch"+=\("$_p.deb::$_repo${_p}_${_vers}_$_sarch.deb"\)
	done
done

prepare() {
	mkdir deb
	for _p in "${_pkgs[@]}"; do
		ar p "$_p.deb" data.tar.xz | tar xJC deb
	done
	ln -sfr deb/lib/libxcrypt.so.1 deb/lib/libxcrypt.so

	cd "$pkgname-$pkgver"
	patch -Nup1 -i "$srcdir/libxcrypt.patch"
	patch -Nup1 -i "$srcdir/fixtimeout.patch"
}

build() {
	cd "$pkgname-$pkgver"
	make
}

package() {
	cd "$pkgname-$pkgver"
	install -D asleap "$pkgdir/usr/bin/asleap"
	install -D genkeys "$pkgdir/usr/bin/genkeys"

	cd "$srcdir/deb"
	_so=lib/libxcrypt.so.1.2.4
	install -D $_so -t "$pkgdir/usr/lib"
	ln -s /usr/$_so "$pkgdir/usr/lib/libxcrypt.so"
	ln -s /usr/$_so "$pkgdir/usr/lib/libxcrypt.so.1"
}
